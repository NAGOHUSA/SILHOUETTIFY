<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Silhouettify – Free Photo to Silhouette SVG Converter</title>
  <meta name="description" content="Silhouettify – Instantly turn any photo into a clean, customizable silhouette SVG. 100% free, no upload, works offline."/>
  <style>
    :root {
      --primary: #8b5cf6;
      --primary-dark: #7c3aed;
      --bg: #faf5ff;
      --card: #ffffff;
    }
    body {font-family: 'Segoe UI', system-ui, sans-serif;background: var(--bg);margin: 0;padding: 20px;text-align: center;color: #333;min-height: 100vh;}
    h1 {color: var(--primary-dark);margin-bottom: 4px;font-size: 2.8rem;}
    .subtitle {color: #a78bfa;font-weight: 600;margin-bottom: 20px;}
    .creator {font-size: 1.1rem;color: #6b7280;margin-bottom: 30px;}
    .creator a {color: var(--primary);text-decoration: none;}
    .creator a:hover {text-decoration: underline;}
    .container {max-width: 720px;margin: 0 auto;}
    #drop-area {
      border: 4px dashed #d8b4fe;border-radius: 20px;padding: 50px;margin: 20px auto;
      background: var(--card);transition: all 0.3s;cursor: pointer;font-size: 1.2rem;
    }
    #drop-area.dragover {border-color: var(--primary);background: #f3e8ff;}
    #preview-canvas {max-width: 100%;border-radius: 16px;box-shadow: 0 20px 40px rgba(139,92,246,0.15);margin: 30px 0;}
    .controls {background: var(--card);padding: 25px;border-radius: 16px;box-shadow: 0 10px 30px rgba(139,92,246,0.1);margin: 20px 0;}
    .control {margin: 18px 0;text-align: left;display: flex;align-items: center;justify-content: space-between;flex-wrap: wrap;gap: 12px;}
    label {font-weight: 600;color: #5b21b6;min-width: 140px;}
    input[type="range"] {flex: 1;max-width: 320px;}
    button {background: var(--primary);color: white;border: none;padding: 14px 28px;border-radius: 12px;font-size: 16px;font-weight: 600;cursor: pointer;transition: 0.2s;}
    button:hover {background: var(--primary-dark);transform: translateY(-2px);}
    button.secondary {background: #94a3b8;}
    #output-svg {background: var(--card);padding: 30px;border-radius: 16px;margin: 30px 0;box-shadow: 0 20px 40px rgba(139,92,246,0.15);}
    #output-svg svg {width: 100%;height: auto;}
    .hidden {display: none;}
    footer {margin-top: 80px;color: #94a3b8;font-size: 14px;}
    footer a {color: var(--primary);}
  </style>
</head>
<body>
  <div class="container">
    <h1>Silhouettify</h1>
    <div class="subtitle">Free Photo to Silhouette SVG Converter</div>
    <div class="creator">Created by <a href="https://nagohcreative.com" target="_blank">NagohCreative.Com</a></div>

    <div id="drop-area">
      <p>Click or drag & drop your photo here</p>
      <input type="file" id="file-input" accept="image/*" style="display:none"/>
    </div>

    <canvas id="preview-canvas" class="hidden"></canvas>

    <div class="controls hidden" id="controls">
      <div class="control">
        <label>Silhouette Color:</label>
        <input type="color" id="fill-color" value="#000000"/>
      </div>
      <div class="control">
        <label>Simplify:</label>
        <input type="range" id="turd-size" min="0" max="10" step="0.5" value="2"/>
        <span id="turd-value">2</span>
      </div>
      <div class="control">
        <button id="convert-btn">Generate Silhouette SVG</button>
        <button id="invert-btn" class="secondary">Invert</button>
      </div>
    </div>

    <div id="output-svg" class="hidden"></div>
    <button id="download-btn" class="hidden">Download Silhouettify.svg</button>

    <footer>
      Silhouettify by <a href="https://nagohcreative.com" target="_blank">NagohCreative.Com</a> • 100% client-side • Open source on GitHub
    </footer>
  </div>

  <!-- OpenCV.js -->
  <script async src="https://docs.opencv.org/4.9.0/opencv.js" onload="onOpenCVReady()"></script>

  <!-- Potrace WASM -->
  <script src="https://unpkg.com/@plotters/potrace@2.0.0/dist/potrace.min.js"></script>

  <script>
    let originalImageData = null;
    let isInverted = false;

    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const canvas = document.getElementById('preview-canvas');
    const ctx = canvas.getContext('2d');
    const controls = document.getElementById('controls');
    const outputDiv = document.getElementById('output-svg');
    const downloadBtn = document.getElementById('download-btn');

    // === FIXED DRAG & DROP + CLICK ===
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
      dropArea.addEventListener(evt, preventDefaults, false);
    });

    ['dragenter', 'dragover'].forEach(evt => {
      dropArea.addEventListener(evt, () => dropArea.classList.add('dragover'), false);
    });

    ['dragleave', 'drop'].forEach(evt => {
      dropArea.addEventListener(evt, () => dropArea.classList.remove('dragover'), false);
    });

    dropArea.addEventListener('drop', e => {
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) handleFile(file);
    });

    dropArea.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', e => {
      if (e.target.files[0]) handleFile(e.target.files[0]);
    });
    // === END FIXED SECTION ===

    function handleFile(file) {
      const reader = new FileReader();
      reader.onload = e => {
        const img = new Image();
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          canvas.classList.remove('hidden');
          controls.classList.remove('hidden');
          outputDiv.classList.add('hidden');
          downloadBtn.classList.add('hidden');
          processWithOpenCV(img);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function onOpenCVReady() {
      console.log("OpenCV.js ready – you can now upload images!");
    }

    function processWithOpenCV(img) {
      ctx.drawImage(img, 0, 0);
      let src = cv.imread(canvas);
      let gray = new cv.Mat();
      let blurred = new cv.Mat();
      let thresh = new cv.Mat();

      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
      cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0);
      cv.adaptiveThreshold(blurred, thresh, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY_INV, 15, 10);

      cv.imshow(canvas, thresh);
      originalImageData = thresh.clone();

      src.delete(); gray.delete(); blurred.delete(); thresh.delete();
    }

    document.getElementById('invert-btn').onclick = () => {
      if (!originalImageData) return;
      isInverted = !isInverted;
      let mat = originalImageData.clone();
      if (isInverted) cv.bitwise_not(mat, mat);
      cv.imshow(canvas, mat);
      mat.delete();
    };

    document.getElementById('turd-size').oninput = e => {
      document.getElementById('turd-value').textContent = e.target.value;
    };

    document.getElementById('convert-btn').onclick = () => {
      const turdSize = parseFloat(document.getElementById('turd-size').value);
      const fillColor = document.getElementById('fill-color').value;

      const svg = Potrace.potrace(canvas, {
        turdSize: turdSize,
        turnPolicy: Potrace.TURNPOLICY_MINORITY,
        background: 'transparent',
        color: fillColor
      });

      const finalSvg = svg.replace(/fill="[^"]*"/g, `fill="${fillColor}"`);

      outputDiv.innerHTML = finalSvg;
      outputDiv.classList.remove('hidden');
      downloadBtn.classList.remove('hidden');

      downloadBtn.onclick = () => {
        const blob = new Blob([finalSvg], {type: 'image/svg+xml'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'silhouettify.svg';
        a.click();
        URL.revokeObjectURL(url);
      };
    };
  </script>
</body>
</html>
